<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ä¼‘å‡ç™»è¨˜ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <style>
    body { font-family: "Noto Sans TC", Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px;}
    .container { max-width:900px; margin:auto;}
    .card { background:white; border-radius:12px; padding:20px; margin-bottom:30px; box-shadow:0 4px 10px rgba(0,0,0,0.08);}
    label { display:block; margin-top:15px; font-weight:bold;}
    input, select, textarea, button { width:100%; margin-top:6px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px;}
    button { background:#4f46e5; color:white; border:none; margin-top:20px; cursor:pointer;}
    button:hover { background:#4338ca;}
    #calendar { height:500px; border-radius:8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ“… ä¼‘å‡ç™»è¨˜ç³»çµ±</h1>

  <div class="card">
    <h2>ğŸ“ ä¼‘å‡ç”³è«‹</h2>
    <form id="leaveForm" target="hidden_iframe" method="POST"
      action="https://docs.google.com/forms/u/0/d/1x4_Qp6DXdyMEwoq8cFZCSFM9XrEtUgbl3UoLKRqamb8/formResponse">

      <label>å§“å</label>
      <input type="text" name="entry.1976827451" required>

      <label>ä¼‘å‡é–‹å§‹æ—¥</label>
      <input type="date" id="start_date" required>

      <label>ä¼‘å‡çµæŸæ—¥</label>
      <input type="date" id="end_date" required>

      <label>å‡åˆ¥</label>
      <select name="entry.1551710315" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
        <option value="äº‹å‡">äº‹å‡</option>
        <option value="ç—…å‡">ç—…å‡</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>

      <label>å‚™è¨»</label>
      <textarea name="entry.2071643667" rows="3"></textarea>

      <!-- hidden inputs for Google Form date fields -->
      <input type="hidden" name="entry.1083401554_year" id="start_year">
      <input type="hidden" name="entry.1083401554_month" id="start_month">
      <input type="hidden" name="entry.1083401554_day" id="start_day">

      <input type="hidden" name="entry.678899297_year" id="end_year">
      <input type="hidden" name="entry.678899297_month" id="end_month">
      <input type="hidden" name="entry.678899297_day" id="end_day">

      <button type="submit">ğŸ“¤ æäº¤ä¼‘å‡</button>
    </form>
  </div>

  <div class="card">
    <h2>ğŸ—“ï¸ ä¼‘å‡æœˆæ›†</h2>
    <div id="calendar"></div>
  </div>
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
const form = document.getElementById('leaveForm');
const startInput = document.getElementById('start_date');
const endInput = document.getElementById('end_date');

function fillHiddenDates(){
  if(startInput.value){
    const d = new Date(startInput.value);
    document.getElementById('start_year').value = d.getFullYear();
    document.getElementById('start_month').value = d.getMonth()+1;
    document.getElementById('start_day').value = d.getDate();
  }
  if(endInput.value){
    const d = new Date(endInput.value);
    document.getElementById('end_year').value = d.getFullYear();
    document.getElementById('end_month').value = d.getMonth()+1;
    document.getElementById('end_day').value = d.getDate();
  }
}

startInput.addEventListener('change', fillHiddenDates);
endInput.addEventListener('change', fillHiddenDates);

// æœˆæ›†
async function loadEvents(){
  const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRq1zsQ8krn9aflClnTqSxI_Nsw866lq6pVdehvJAocW4hGISGPRR7BTOSBNConlCZ-UiaTnnUKMEbU/pub?output=csv');
  const csv = await res.text();
  const rows = csv.split('\n').map(r => r.split(',').map(c=>c.replace(/^"|"$/g,'')));
  const header = rows[0];
  const data = rows.slice(1);
  const events = [];
  const idxName = header.indexOf('å§“å');
  const idxStart = header.indexOf('ä¼‘å‡æ—¥æœŸ'); // å¦‚æœä½ çš„ Sheet æœ‰æ‹† start/end å¯ä»¥æ”¹
  const idxEnd = header.indexOf('ä¼‘å‡çµæŸæ—¥');
  const idxType = header.indexOf('å‡åˆ¥');
  const idxNote = header.indexOf('å‚™è¨»');

  data.forEach(r=>{
    if(!r || !r[idxStart]) return;
    let start = r[idxStart];
    let end = r[idxEnd] || start;
    events.push({
      title:`${r[idxName]}ï¼ˆ${r[idxType]}ï¼‰`,
      start,
      end,
      allDay:true,
      extendedProps:{note:r[idxNote] || ''}
    });
  });
  return events;
}

let calendar;
async function initCalendar(){
  const events = await loadEvents();
  const calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl,{
    initialView:'dayGridMonth',
    locale:'zh-tw',
    height:'auto',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,listMonth'},
    events,
    eventClick(info){
      if(info.event.extendedProps.note) alert('å‚™è¨»ï¼š'+info.event.extendedProps.note);
    }
  });
  calendar.render();
}

initCalendar();

// è¡¨å–®é€å‡ºå¾Œ
form.addEventListener('submit', e=>{
  fillHiddenDates();
  alert('å·²é€å‡ºä¼‘å‡ç”³è«‹ï¼');
  setTimeout(initCalendar, 5000); // ç­‰ Sheet æ›´æ–°å¾Œåˆ·æ–°æœˆæ›†
});
</script>
</body>
</html>
